var lock=!1,submit=$(".submit"),formInput=$(".menu-must"),pickBtn=$(".pickBtn"),pickUp=$(".pickup"),menus=$("#menu").length?JSON.parse($("#menu").val()):"";function action(n,t,e){$.ajax({type:"POST",url:"/admin/menus-action",dataType:"json",data:n,success:function(n){0===n.status?($.growl.notice({message:t}),e&&e()):$.growl.error({message:n.msg})}})}function precheck(){var n=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{context:".card-form",msg:"新增成功!",type:"add",_id:"",callback:function(){}};if(!lock){lock=!0,setTimeout(function(){lock=!1},300);var l=[];$(n.context).find(".menu-must").each(function(n,t){var e=$(t).val();e&&l.push(e)});var a={};if($(n.context).find(".json-key").each(function(n,t){var e=$(t).val(),l=$(t).siblings(".json-value").val();e&&l&&(a[e]=l)}),l.length){var t={type:n.type,name:l[0],link:l[1],show:!0};"{}"!=JSON.stringify(a)&&(t.settings=a),"add"!==n.type&&(t._id=n._id),action(t,n.msg,function(){$(n.context).find(".menu-must").val(""),n.callback&&n.callback()})}}}formInput.on("input",function(){var e=[];formInput.each(function(n,t){$(t).val()&&e.push(1)}),e.length===formInput.length?submit.removeClass("btn-disabled"):submit.addClass("btn-disabled")}),$(document).on("click","a.submit",function(){precheck()}),$(document).on("keydown",".submit",function(n){13===n.keyCode&&precheck()}),$(document).on("click",".add-row",function(){var n=$(this),t=n.closest(".form-label-input").clone(),e=n.closest(".label-inline");e.find(".form-label-input").eq(0).find(".remove-row").removeClass("hide"),t.find(".remove-row").removeClass("hide"),e.append(t)}),$(document).on("click",".remove-row",function(){var n=$(this),t=n.closest(".form-label-input"),e=n.closest(".label-inline");t.remove(),e.find(".form-label-input").eq(0).find(".remove-row").addClass("hide")}),pickBtn.on("click",function(){pickBtn.toggleClass("rotated"),pickUp.toggleClass("expend")});var growl=null;$(document).on("click",".btn-edit",function(){for(var n=$(this).attr("data-index"),t=menus[n],e="",l=t.settings?Object.keys(t.settings).length:2,a=0;a<l;a++)e+='\n        <div class="form-label-input">\n            <input class="json-key form-input" type="text" placeholder="key" value="title">-<input class="json-value form-input" type="text" placeholder="value">\n            <span class="btn add-row">+</span>\n            <span class="btn remove-row">-</span>\n        </div>';growl=$.growl({duration:!1,clickToClose:!1,layout:"menu-edit",location:"dialog",title:"编辑菜单",message:'<div class="label-block">\n            <label class="form-label">菜单名称:</label>\n            <div class="form-label-input label-inline">\n                <input class="form-input menu-must" type="text" placeholder="填写菜单名称", value="'.concat(t.name,'">\n            </div>\n        </div>\n        <div class="label-block">\n            <label class="form-label">菜单链接:</label>\n            <div class="form-label-input label-inline">\n                <input class="form-input menu-must" type="text" placeholder="填写菜单链接", value="').concat(t.link,'">\n            </div>\n        </div>\n        <div class="label-block">\n            <label class="form-label">菜单附属数据(用于扩展菜单字段):</label>\n            <div class="label-inline">').concat(e,'</div>\n        </div>\n        <div class="tac">\n            <a class="btn js-update" href="javascript:;" title="填写后可提交" data-id=').concat(t._id,'>提交</a>\n            <a class="btn btn-cancel js-cancel" href="javascript:;" title="取消" style="margin-left:20px;">取消</a>\n        </div>')})}),$(document).on("click",".js-update",function(n){precheck({_id:$(this).attr("data-id"),context:"#growls-dialog",msg:"更新成功!",type:"update",callback:function(){growl.close(n)}})}),$(document).on("click",".js-cancel",function(n){growl.close(n)}),$(document).on("click",".btn-delete",function(){if(!lock){lock=!0,setTimeout(function(){lock=!1},300);var n=$(this);action({type:"remove",_id:n.attr("data-id")},"删除成功!",function(){n.closest("tr").remove()})}}),$(document).on("click",".btn-action",function(){if(!lock){lock=!0,setTimeout(function(){lock=!1},300);var n=$(this),t="show"==n.attr("data-type");action({type:"update",_id:n.attr("data-id"),show:t},t?"菜单已显示!":"菜单已隐藏!",function(){n.addClass("hide").siblings(".btn-action").removeClass("hide")})}});